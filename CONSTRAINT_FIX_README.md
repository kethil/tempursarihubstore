# Service Request Constraint Violation Fix

## Problem
Users were encountering a "duplicate key value violates unique constraint 'service_requests_request_number_key'" error when submitting service requests in both web and mobile applications.

## Root Cause
The database trigger `set_request_number()` was only checking for `NULL` values (`NEW.request_number IS NULL`) but both applications were sending empty strings (`''`) instead of `NULL`. This caused multiple requests to be inserted with empty strings, violating the unique constraint.

## Solution Applied

### 1. Database Fix (Migration)
Created migration: `20250102000000_fix_request_number_trigger.sql`
- Updated the trigger function to handle both `NULL` and empty string values
- Now checks: `IF NEW.request_number IS NULL OR NEW.request_number = ''`

### 2. Application Code Fix
**Web App:** `src/components/ServiceRequestForm.tsx`
- Set `request_number: null as any` in the insert operation
- Let the database trigger handle request number generation completely

**Mobile App:** `mobile/src/services/api.ts`
- Set `request_number: null as any` in the insert operation  
- Let the database trigger handle request number generation completely

## Deployment Steps

### 1. Apply Database Migration
The new migration file needs to be applied to the Supabase database:
```sql
-- This will be automatically applied when the migration is pushed
-- Or run manually in Supabase SQL editor:
CREATE OR REPLACE FUNCTION public.set_request_number()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  IF NEW.request_number IS NULL OR NEW.request_number = '' THEN
    NEW.request_number := public.generate_request_number();
  END IF;
  RETURN NEW;
END;
$$;
```

### 2. Deploy Application Updates
- Deploy the updated web application
- Deploy the updated mobile application

## Expected Result
- Service request submissions should work without constraint violations
- Request numbers will be automatically generated by the database trigger
- Both web and mobile apps will receive the generated request number in the response

## Verification
After deployment, test:
1. Submit a service request from the web app
2. Submit a service request from the mobile app
3. Verify both receive unique, auto-generated request numbers
4. Confirm no constraint violation errors occur

## Technical Details
- The trigger uses format: `REQ-YYYYMMDD-XXXX` (e.g., `REQ-20250102-0001`)
- Counter increments daily and resets each day
- Unique constraint is maintained through proper auto-generation
- Both platforms now use consistent approach with database-generated values